@(admin: Admin)
@import views.html.admin.template
@template(admin){
    <div id="div_cursos" class="col-md-10">
        <div class="col-md-6">
            <h3 style="display: inline-block">Cursos</h3>
            <div id="add_curso">
                <form class="form-horizontal">
                    <input type="text" id="add_curso_name" name="name" placeholder="Nombre..." style="width: 130px">
                    <button id="add_curso_plus" class="btn btn-sm btn-primary">+</button>
                    <button id="curso_addl" class="btn btn-sm btn-primary">+ lista</button>
                </form>
            </div>
            <table id="cursos_tab" class="display">
                <thead>
                    <tr style="cursor: pointer">
                        <th>Nombre</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                @for(course <- Course.find.all()) {
                    <tr data-id="@{course.id}">
                        <td>@course.name</td>
                        <td>
                            <button class="btn btn-sm btn-primary">Editar</button>
                            <button class="btn btn-sm btn-primary hidden">Guardar</button>
                            <button class="btn btn-sm btn-primary hidden">Cancelar</button>
                            <button class="btn btn-sm btn-danger">Eliminar</button>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
            <div id="addl_curso" style="display: none">
                <form class="form-horizontal">
                    <h3 class="text-center">Nuevos Cursos</h3>
                    <div class="form-group">
                        <label class="col-md-4">Nombres:</label>
                        <textarea id="addl_curso_names" name="names" rows="6" cols="35"></textarea>
                    </div>
                    <button id="addl_curso_aceptar" class="btn btn-primary">Aceptar</button>
                </form>
            </div>
        </div>
        <div class="col-md-6 hidden">
            <h3 style="display: inline-block">Temas</h3>
            <div id="add_theme">
                <form class="form-horizontal">
                    <input type="text" id="add_theme_name" name="name" placeholder="Nombre..." style="width: 130px">
                    <button id="add_theme_plus" class="btn btn-sm btn-primary">+</button>
                    <button id="theme_addl" class="btn btn-sm btn-primary">+ lista</button>
                </form>
            </div>
            <table id="themes_tab" class="display">
                <thead>
                    <tr style="cursor: pointer">
                        <th>Nombre</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div id="addl_theme" style="display: none">
                <form class="form-horizontal">
                    <h3 class="text-center">Nuevos Temas</h3>
                    <div class="form-group">
                        <label class="col-md-4">Nombres:</label>
                        <textarea id="addl_theme_names" name="names" rows="6" cols="35"></textarea>
                    </div>
                    <button id="addl_theme_aceptar" class="btn btn-primary">Aceptar</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        function editable(elem,edit){
            if(edit)$(elem).attr("contenteditable",edit)
            else $(elem).removeAttr("contenteditable")
        }
        var datatable_cursos,datatable_themes;
        function start_datatable_cursos(){
            datatable_cursos=$("#cursos_tab").dataTable({
                //"pagingType": "simple_numbers"
                bFilter: false,bInfo: false,"sScrollY" : "200","paging":false,
                "language": {
                    //"lengthMenu": "Display _MENU_ records per page",
                    //"zeroRecords": "No se encontraron coincidencias",
                    "infoEmpty": "No se encontraron cursos"
                    //"infoFiltered": "(filtrado de _MAX_ registros en total)"
                }
            })
        }
        function add_tr_curso(id,name){
            return '<tr data-id="'+id+'"><td>'+name+'</td><td><button class="btn btn-sm btn-primary">Editar</button>'+
                '<button class="btn btn-sm btn-primary hidden">Guardar</button>'+
                '<button class="btn btn-sm btn-primary hidden">Cancelar</button>'+
                '<button class="btn btn-sm btn-danger">Eliminar</button></td></tr>'
        }
        function add_cursos(courses){
            datatable_cursos.fnDestroy()
            for(var i in courses){
                $("#cursos_tab tbody").append(add_tr_curso(courses[i].id,courses[i].name))
                editable($("#cursos_tab tbody tr:last-child td"))
            }
            start_datatable_cursos()
        }
        function start_datatable_themes(){
            datatable_themes=$("#themes_tab").dataTable({bFilter: false,bInfo: false,"sScrollY" : "200","paging":false,
                "language": {"infoEmpty": "No se encontraron temas"}})
        }
        function add_tr_theme(id,name){
            return '<tr data-id="'+id+'"><td>'+name+'</td><td><button class="btn btn-sm btn-primary">Editar</button>'+
                '<button class="btn btn-sm btn-primary hidden">Guardar</button>'+
                '<button class="btn btn-sm btn-primary hidden">Cancelar</button>'+
                '<button class="btn btn-sm btn-danger">Eliminar</button></td></tr>'
        }
        function add_themes(themes){
            datatable_themes.fnDestroy()
            for(var i in themes){
                $("#themes_tab tbody").append(add_tr_theme(themes[i].id,themes[i].name))
                editable($("#themes_tab tbody tr:last-child td"))
            }
            start_datatable_themes()
        }
        start_datatable_cursos()
        $("#cursos_tab tbody").on( 'click', 'tr', function (e) {
            if ( $ ( this ).hasClass ( 'selected' ) ) $ ( this ).removeClass ( 'selected' )
            else {
            $ ( "#cursos_tab tr.selected" ).removeClass ( 'selected' ) ;
            $ ( this ).addClass ( 'selected' ) ;
            }
            $.ajax ( {
                type : "POST",
                url : "administrador/listtheme",
                async : false,
                data : { course_id : $ ( this ).attr ( "data-id" ) },
                success : function ( themes ) {
                if ( typeof datatable_themes !== "undefined" ) datatable_themes.fnDestroy ( )
                    $ ( "#themes_tab" ).parent ( ).removeClass ( "hidden" )
                    $ ( "#themes_tab tbody" ).text ( "" )
                    for ( var i in themes ) {
                        $ ( "#themes_tab tbody" ).append ( add_tr_theme ( themes[ i ].id, themes[ i ].name ) )
                    }
                    start_datatable_themes ( )
                }
            } )
            cleanForm ( $ ( "#add_theme form" ) )
            $ ( "#add_theme form" ).validate ( {
                rules : {
                    name : { required : true, exist : { model : "Theme", column : "name", condition : "course_id:" + $ ( "#cursos_tab tr.selected" ).attr ( "data-id" ),
                    message : "El tema ? del curso " + $ ( "#cursos_tab tr.selected td:nth-child(1)").text() + " ya existe" } }
                },
                errorPlacement : function ( error, element ) {
                    $ ( error ).addClass ( 'alert alert-danger' )
                    $ ( element ).parent ( ).append ( error )
                }
            } )
        })
        $("#cursos_tab tbody").on( 'click', 'button', function (e) {
            var tr=$(this).parent().parent()
            var hidden=$(this).parent().find(".hidden")
            var visible=$(this).parent().find(":not('.hidden')")
            e.stopPropagation()
            if($(this).text()=='Editar'){
                editable(tr,true)
                $(hidden).removeClass("hidden")
                $(visible).addClass("hidden")
            }
            if($(this).text()=='Guardar'){
                $.ajax ( {
                    type : "POST",
                    url : "administrador/updatecourse",
                    async : false,
                    data : { id:$(tr).attr("data-id"),name:$(tr).find("td:nth-child(1)").text()},
                    success : function () {
                        editable(tr,false)
                        $(hidden).removeClass("hidden")
                        $(visible).addClass("hidden")
                    }
                })
            }
            if($(this).text()=='Cancelar'){
                $.ajax ( {
                    type : "POST",
                    url : "administrador/findcourse",
                    async : false,
                    data : { id:$(tr).attr("data-id")},
                    success : function (course) {
                        editable(tr,false)
                        $(tr).find("td:nth-child(1)").text(course.name)
                        $(hidden).removeClass("hidden")
                        $(visible).addClass("hidden")
                    }
                })
            }
            if($(this).text()=='Eliminar'){
                $.ajax ( {
                    type : "POST",
                    url : "administrador/deletecourse",
                    async : false,
                    data : { id:$(tr).attr("data-id")},
                    success : function (){
                        $(tr).remove()
                        datatable_themes.fnDestroy ()
                        $("#themes_tab").parent().addClass("hidden")
                    }
                })
            }
        })
        $("#themes_tab tbody").on( 'click', 'tr', function () {
            if ( $(this).hasClass('selected') ) $(this).removeClass('selected')
            else {
                $("#themes_tab tr.selected").removeClass('selected');
                $(this).addClass('selected');
            }
        })
        $("#themes_tab tbody").on( 'click', 'button', function (e) {
            var tr=$(this).parent().parent()
            var hidden=$(this).parent().find(".hidden")
            var visible=$(this).parent().find(":not('.hidden')")
            e.stopPropagation()
            if($(this).text()=='Editar'){
                editable(tr,true)
                $(hidden).removeClass("hidden")
                $(visible).addClass("hidden")
            }
            if($(this).text()=='Guardar'){
                $.ajax ( {
                    type : "POST",
                    url : "administrador/updatetheme",
                    async : false,
                    data : { id:$(tr).attr("data-id"),name:$(tr).find("td:nth-child(1)").text()},
                    success : function () {
                        editable(tr,false)
                        $(hidden).removeClass("hidden")
                        $(visible).addClass("hidden")
                    }
                })
            }
            if($(this).text()=='Cancelar'){
                $.ajax ( {
                    type : "POST",
                    url : "administrador/findtheme",
                    async : false,
                    data : { id:$(tr).attr("data-id")},
                    success : function (theme) {
                        editable(tr,false)
                        $(tr).find("td:nth-child(1)").text(theme.name)
                        $(hidden).removeClass("hidden")
                        $(visible).addClass("hidden")
                    }
                })
            }
            if($(this).text()=='Eliminar'){
                $.ajax ( {
                    type : "POST",
                    url : "administrador/deletetheme",
                    async : false,
                    data : { id:$(tr).attr("data-id")},
                    success : function (){
                        $(tr).remove()
                    }
                })
            }
        })
        function cleanForm(form){
            $(form)[0].reset()
            $(form).find(".alert").remove()
            $(form).removeData('validator')
        }
        $("#add_curso form").validate({
            rules:{
                name:{required:true,exist:{model:"Course",column:"name",message:"El curso ? ya existe"}}
            },
            errorPlacement:function(error,element){
                $(error).addClass('alert alert-danger')
                $(element).parent( ).append(error)
            }
        })
        $("#add_curso_plus").click(function(){
            var name=$("#add_curso_name").val()
            if($("#add_curso form").valid()){
                $.ajax ( {
                    type : "POST",
                    url : "administrador/addcourses",
                    async: false,
                    data : {names:name,delimiter:","},
                    success : function (courses) {
                        add_cursos(courses)
                    }
                })
            }
            return false
        })
        $("#addl_curso").dialog({
            autoOpen:false,
            modal:true,
            width:350,
            height:"auto"
        });
        $("#curso_addl").click(function(){
            cleanForm($("#addl_curso form"))
            $("#addl_curso").dialog("open")
            $("#addl_curso form").validate({
                rules:{
                    names:{required:true,listexist:{model:"Course",column:"name",message:"Los cursos: ? ya existen",
                        delimiter:","}}
                },
                errorPlacement:function(error,element){
                    $(error).addClass('alert alert-danger').css({"margin-left":15})
                    $(element).after(error)
                }
            })
            return false
        })
        $("#addl_curso_aceptar").click(function(){
            var names=$("#addl_curso_names").val( ),delimiter=",";
            if($("#addl_curso form").valid()){
                $("#addl_curso").dialog('close')
                $.ajax ( {
                    type : "POST",
                    url : "administrador/addcourses",
                    async: false,
                    data : {names:names,delimiter:delimiter},
                    success : function (courses) {
                        add_cursos(courses)
                    }
                })
            }
            return false
        })
        $("#add_theme_plus").click(function(){
            var name=$("#add_theme_name").val()
            if($("#add_theme form").valid()){
                $.ajax ( {
                    type : "POST",
                    url : "administrador/addthemes",
                    async: false,
                    data : {names:name,course_id:$("#cursos_tab tr.selected").attr("data-id"),delimiter:","},
                    success : function (themes) {
                        add_themes(themes)
                    }
                })
            }
            return false
        })
        $("#addl_theme").dialog({
            autoOpen:false,
            modal:true,
            width:350,
            height:"auto"
        });
        $("#theme_addl").click(function(){
            cleanForm($("#addl_theme form"))
            $("#addl_theme").dialog("open")
            $("#addl_theme form").validate({
                rules:{
                    names:{required:true,listexist:{model:"Theme",column:"name",condition:"course_id:"+$("#cursos_tab tr.selected").attr("data-id"),
                        message:"Los temas: ? del curso "+$("#cursos_tab tr.selected td").text()+" ya existen",
                        delimiter:","}}
                },
                errorPlacement:function(error,element){
                    $(error).addClass('alert alert-danger').css({"margin-left":15})
                    $(element).after(error)
                }
            })
            return false
        })
        $("#addl_theme_aceptar").click(function(){
            var names=$("#addl_theme_names").val( ),delimiter=",";
            if($("#addl_theme form").valid()){
                $("#addl_theme").dialog('close')
                $.ajax ( {
                    type : "POST",
                    url : "administrador/addthemes",
                    async: false,
                    data : {names:names,course_id:$("#cursos_tab tr.selected").attr("data-id"),delimiter:delimiter},
                    success : function(themes) {
                        add_themes(themes)
                    }
                })
            }
            return false
        })
    </script>
}
