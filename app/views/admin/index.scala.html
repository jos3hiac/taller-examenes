@(admin: Admin)
@main("Administrador") {
    <div>
        Bienvenido <b>@admin.name</b><a href="/logout" class="btn btn-primary">Cerrar Sesion</a>
    </div>
    <div id="div_cursos" class="col-md-6 col-md-offset-2">
        <div class="col-md-5">
            <h3 style="display: inline-block">Cursos</h3>
            <div id="add_curso">
                <form class="form-horizontal">
                    <input type="text" id="add_curso_name" name="name" placeholder="Nombre..." style="width: 130px">
                    <button id="add_curso_plus" class="btn btn-sm btn-primary">+</button>
                    <button id="curso_addl" class="btn btn-sm btn-primary">+ lista</button>
                </form>
            </div>
            <table id="cursos_tab" class="display">
                <thead>
                    <tr style="cursor: pointer">
                        <th>Nombre</th>
                    </tr>
                </thead>
                <tbody>
                @for(course <- Course.find.all()) {
                    <tr data-id="@{course.id}">
                        <td>@course.name</td>
                    </tr>
                }
                </tbody>
            </table>
            <button id="cursos_guardar" class="btn btn-sm btn-primary pull-right">Guardar</button>
            <div id="addl_curso" style="display: none">
                <form class="form-horizontal">
                    <h3 class="text-center">Nuevos Cursos</h3>
                    <div class="form-group">
                        <label class="col-md-4">Nombres:</label>
                        <textarea id="addl_curso_names" name="names" rows="6" cols="35"></textarea>
                    </div>
                    <button id="addl_curso_aceptar" class="btn btn-primary">Aceptar</button>
                </form>
            </div>
        </div>
        <div class="col-md-5 hidden">
            <h3 style="display: inline-block">Temas</h3>
            <div id="add_theme">
                <form class="form-horizontal">
                    <input type="text" id="add_theme_name" name="name" placeholder="Nombre..." style="width: 130px">
                    <button id="add_theme_plus" class="btn btn-sm btn-primary">+</button>
                    <button id="theme_addl" class="btn btn-sm btn-primary">+ lista</button>
                </form>
            </div>
            <table id="themes_tab" class="display">
                <thead>
                    <tr style="cursor: pointer">
                        <th>Nombre</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <button id="themes_guardar" class="btn btn-sm btn-primary pull-right">Guardar</button>
            <div id="addl_theme" style="display: none">
                <form class="form-horizontal">
                    <h3 class="text-center">Nuevos Temas</h3>
                    <div class="form-group">
                        <label class="col-md-4">Nombres:</label>
                        <textarea id="addl_theme_names" name="names" rows="6" cols="35"></textarea>
                    </div>
                    <button id="addl_theme_aceptar" class="btn btn-primary">Aceptar</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        function editable(elem){
            $(elem).on('focus',function(){
                $(this).attr("data-text",$(this).text())
            })
            $(elem).dblclick(function(){
                $(this).attr("contenteditable",true)
            })
            $(elem).on('blur',function(){
                //if($(this).attr("data-text")!==$(this).text()){
                //    $(this).attr("data-text",$(this).text())
                //}
                $(this).removeAttr("contenteditable")
            })
        }
        editable($("#cursos_tab tbody td"))
        var datatable_cursos,datatable_themes;
        function start_datatable_cursos(){
            datatable_cursos=$("#cursos_tab").dataTable({
                //"pagingType": "simple_numbers"
                bFilter: false,bInfo: false,"sScrollY" : "200","paging":false,
                "language": {
                    //"lengthMenu": "Display _MENU_ records per page",
                    //"zeroRecords": "No se encontraron coincidencias",
                    "infoEmpty": "No se encontraron cursos"
                    //"infoFiltered": "(filtrado de _MAX_ registros en total)"
                }
            })
        }
        function add_names_cursos(names){
            datatable_cursos.fnDestroy()
            for(var i in names){
                $("#cursos_tab tbody").append('<tr><td>'+names[i]+'</td></tr>')
                editable($("#cursos_tab tbody tr:last-child td"))
            }
            start_datatable_cursos()
        }
        function start_datatable_themes(){
            datatable_themes=$("#themes_tab").dataTable({bFilter: false,bInfo: false,"sScrollY" : "200","paging":false,
                "language": {"infoEmpty": "No se encontraron temas"}})
        }
        function add_names_themes(names){
            datatable_themes.fnDestroy()
            for(var i in names){
                $("#themes_tab tbody").append('<tr><td>'+names[i]+'</td></tr>')
                editable($("#themes_tab tbody tr:last-child td"))
            }
            start_datatable_themes()
        }
        start_datatable_cursos()
        $("#cursos_tab tbody").on( 'click', 'tr', function () {
            if ( $(this).hasClass('selected') ) $(this).removeClass('selected')
            else {
                $("#cursos_tab tr.selected").removeClass('selected');
                $(this).addClass('selected');
            }
            if($(this)[0].hasAttribute("data-id")){
                $.ajax ( {
                    type : "POST",
                    url : "administrador/listtheme",
                    async: false,
                    data : {courseid:$(this ).attr("data-id")},
                    success : function (themes) {
                        if(typeof datatable_themes !== "undefined")datatable_themes.fnDestroy()
                        $("#themes_tab").parent( ).removeClass("hidden")
                        $("#themes_tab tbody").text("")
                        for(var i in themes){
                            $("#themes_tab tbody").append('<tr data-id="'+themes[i].id+'"><td>'+themes[i].name+'</td></tr>')
                            editable($("#themes_tab tbody tr:last-child td"))
                        }
                        start_datatable_themes()
                    }
                })
                cleanForm($("#add_theme form"))
                $("#add_theme form").validate({
                    rules:{
                        name:{required:true,exist:{model:"Theme",column:"name",condition:"course_id:"+$("#cursos_tab tr.selected").attr("data-id"),
                            message:"El tema ? del curso "+$("#cursos_tab tr.selected td").text()+" ya existe"}}
                    },
                    errorPlacement:function(error,element){
                        $(error).addClass('alert alert-danger')
                        $(element).parent( ).append(error)
                    }
                })
            }
            else{
                if(typeof datatable_themes !== "undefined")datatable_themes.fnDestroy()
                $("#themes_tab").parent( ).addClass("hidden")
            }
        })
        $("#themes_tab tbody").on( 'click', 'tr', function () {
            if ( $(this).hasClass('selected') ) $(this).removeClass('selected')
            else {
                $("#themes_tab tr.selected").removeClass('selected');
                $(this).addClass('selected');
            }
        })
        function cleanForm(form){
            $(form)[0].reset()
            $(form).find(".alert").remove()
            $(form).removeData('validator')
        }
        $("#add_curso form").validate({
            rules:{
                name:{required:true,exist:{model:"Course",column:"name",message:"El curso ? ya existe"}}
            },
            errorPlacement:function(error,element){
                $(error).addClass('alert alert-danger')
                $(element).parent( ).append(error)
            }
        })
        $("#add_curso_plus").click(function(){
            if($("#add_curso form").valid()){
                add_names_cursos([$("#add_curso_name").val()])
            }
            return false
        })
        $("#addl_curso").dialog({
            autoOpen:false,
            modal:true,
            width:350,
            height:"auto"
        });
        $("#curso_addl").click(function(){
            cleanForm($("#addl_curso form"))
            $("#addl_curso").dialog("open")
            $("#addl_curso form").validate({
                rules:{
                    names:{required:true,listexist:{model:"Course",column:"name",message:"Los cursos: ? ya existen",
                        delimiter:","}}
                },
                errorPlacement:function(error,element){
                    $(error).addClass('alert alert-danger').css({"margin-left":15})
                    $(element).after(error)
                }
            })
            return false
        })
        $("#addl_curso_aceptar").click(function(){
            var names=$("#addl_curso_names").val( ),delimiter=",";
            var listnames=names.split(delimiter);
            if($("#addl_curso form").valid()){
                $("#addl_curso").dialog('close')
                add_names_cursos(listnames)
            }
            return false
        })
        $("#cursos_guardar").click(function(){
            /*$.ajax({
                type: "POST",
                async: false,
                url: "administrador/validatecourses",
                data: {delimiter:delimiter,names:names},
                success: function(msg){
                    if(msg!="")error=msg
                }
            })*/
        })
        $("#add_theme_plus").click(function(){
            if($("#add_theme form").valid()){
                add_names_themes([$("#add_theme_name").val()])
            }
            return false
        })
        $("#addl_theme").dialog({
            autoOpen:false,
            modal:true,
            width:350,
            height:"auto"
        });
        $("#theme_addl").click(function(){
            cleanForm($("#addl_theme form"))
            $("#addl_theme").dialog("open")
            $("#addl_theme form").validate({
                rules:{
                    names:{required:true,listexist:{model:"Theme",column:"name",condition:"course_id:"+$("#cursos_tab tr.selected").attr("data-id"),
                        message:"Los temas: ? del curso "+$("#cursos_tab tr.selected td").text()+" ya existen",
                        delimiter:","}}
                },
                errorPlacement:function(error,element){
                    $(error).addClass('alert alert-danger').css({"margin-left":15})
                    $(element).after(error)
                }
            })
            return false
        })
        $("#addl_theme_aceptar").click(function(){
            var names=$("#addl_theme_names").val( ),delimiter=",";
            var listnames=names.split(delimiter)
            if($("#addl_theme form").valid()){
                $("#addl_theme").dialog('close')
                add_names_themes(listnames)
            }
            return false
        })
    </script>
}
